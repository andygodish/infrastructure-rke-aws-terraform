# Upgrade Path

## Updgrade Downstream Clusters (#1)

### Assumption - Rancher-Created Clusters

Rancher 2.4.5 allows downstream clusters at a maximum version of 1.18.3. We'll need to make sure that all downstream clusters have been upgrade this version.

`Provide justificiation for this at some point`

### _Backup_

Before upgrading each cluster, use the cluster manager to take an etcd snapshot.

To Upgrade, select a cluster and edit its configuration. On the configuration form, under Cluster Options, open the Kubernetes Version dropdown and select v1.18.20-rancher1-1. Save your changes and allow the upgrade process to complete.

---

## Upgrade Upstream Cluster to K8s 1.19.x

### _Backup_

Use RKE to take a one-time snapshot of your upstream cluster before attempting the K8s upgrade:

You'll need to have the cluster.yml file assocaited with the cluster locallay for RKE to reference as seen here: https://rancher.com/docs/rancher/v2.0-v2.4/en/backups/backup/rke-backups/

Once complete, the backup will be stored locally on your etcd nodes at /opt/rancher/opt/rke/etcd-snapshots/. After taking your snapshots, export them to a safe location that wonâ€™t be affected if your cluster encounters issues.

Full documentation for backing up Rancher 2.4 - https://rancher.com/docs/rancher/v2.0-v2.4/en/backups/backup/rke-backups/

### _Update RKE binary_

We'll first want to upgrade the upstream K8s cluster to v1.19.x. This sufices the requirement outlined in the SUSE-Rancher support matrix which states that Rancher 2.5.9 should be run on, a minimum, K8s v1.19.12 as well as a best-practice for upgrading k8s clusters one minor version at a time. 

You'll need a later release of the RKE binary that supports K8s v1.19. Any version will do, I find 1.3.4 to be the most consistent and is the version I will be using to test this upgrade path. This release supports the installation of K8s v1.19.16. 

RKE v1.3.4 release - https://github.com/rancher/rke/releases/tag/v1.3.4

RKE binary installation docs - https://rancher.com/docs/rke/latest/en/installation/#download-the-rke-binary

### _Update cluster.yml_

This is the original configuration yml file you used to initially stand up your cluster with RKE. You'll need to pull this to your local machine for use in subseqent RKE commands. You will also need to bring in the cluster.rkestate file that was generated by RKE after standing up your cluster. The rkestate yml will need to be in the same directory where you perform your RKE up during the upgrade process. 

More info on cluster.yml - https://rancher.com/docs/rke/latest/en/example-yamls/

In your cluster.yml file, update/add the kubernetes_version field and set it to the 1.19.x version associated with the version of RKE you are using. The following will the supported K8s versions:

```
rke config -l -a
```

Once the cluster.yml has been updated, you can run 'rke up' using the '--config' flag to point to your cluster.yml file

```
rke up --config <./your-cluster.yml>
```

Backing up Rancher/RKE via etcd snapshot - https://rancher.com/docs/rancher/v2.0-v2.4/en/backups/backup/rke-backups/

## Upgrade Rancher to 2.5.9 

You'll need to replicate the initial helm install command that was used to create the cluster. The same tags used to in the original installation must be applied to the upgrade command. You'll change the --version tag to reflect 2.5.9 in this case:

```
helm upgrade rancher rancher-stable/rancher \
--namespace cattle-system \
--set hostname=upstream.andygodish.com \
--set ingress.tls.source=letsEncrypt \
--set replicas=3 \
--set letsEncrypy.email=agodish18@gmail.com --version=2.5.12
```
